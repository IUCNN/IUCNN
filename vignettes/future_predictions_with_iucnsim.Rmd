---
title: "Using IUCNN threat status estimates for future predictions with `iucnsim`"
author: "Tobias Andermann"
date: "2/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning=FALSE,
  message=FALSE
)
```

## Load libraries and data

With IUCNN you can predict likely IUCN threat statuses for any group of species. This tutorial demonstrates a downstream application of these estimated threat statuses for simulating future diversity trajectories and threat-status changes of your selected group of species.

For this we need to load the IUCNN and iucnsim libraries. For instructions of how to install `iucnsim` see https://github.com/tobiashofmann88/iucnsim. We'll also need to load the `tidyverse` library.

```{r load libraries}
library(IUCNN)
library(iucnsim)
reticulate::source_python("https://raw.githubusercontent.com/tobiashofmann88/iucn_extinction_simulator/master/iucn_sim/iucn_sim.py")
```

First let us load the tutorial data. here we will only use geographic features.

```{r tutorial_data, echo=TRUE}
data("training_occ") #geographic occurrences of species with IUCN assessment
## Generate features
geo <- geo_features(training_occ) #geographic

features <- geo 

# Prepare training labels
data("training_labels") # the corresponding IUCN assessments
labels_train <- prepare_labels(training_labels)
```

## Train IUCNN model

Now let's train a NN classifier model with the data.

```{r training, echo=TRUE}
# train the model
training_results = train_iucnn(x = features,
                              model_name = "iuc_nn_model",
                              labels = labels_train)
```

## Predict missing statuses

Now we want to predict IUCN categories for our species that lack an IUCN assessment, using our trained IUCNN model. Let's get the data first.

```{r prediction_data, echo=TRUE}
data("prediction_occ") #occurrences from Not Evaluated species to predict
geo <- geo_features(prediction_occ)
features_predict <- geo
```

Next predict the IUCN categories for these species

```{r prediction, echo=TRUE}
labels = predict_iucnn(x = features_predict,
                       model_dir = "iuc_nn_model")
labels
```


To use these predicted labels together with those of the assessed species, we need to convert them back from numeric labels into valid IUCN categories (LC, NT, VU, etc). First let us combine the dataframes to have all of our target species in one dataframe.

```{r}
names(labels) = names(labels_train)
all_target_species = rbind(labels_train,labels)
```


Translate the numeric labels into IUCN threat statuses.

```{r}
all_target_species_status = translate_numeric_labels(all_target_species)
```

## Running `iucnsim`

First we need to define a reference group for which we download the IUCN history of status assessments. From this IUCN history we will then estimate status transition rates in the next step. See the [`iucnsim` tutorial](https://github.com/tobiashofmann88/iucnsim) in case you are wondering what this is all about.

```{r}
reference_group = "Asparagales"
iucn_history_file = get_iucn_history(reference_group=reference_group,
                                     outdir='iucnsim')
```

Now we apply this IUCN history data to count how often any type of status transition occurred int he history of the reference group. These counts are the base for estimating the rates of these status transitions, which will then be applied for running future simulations.

This may take a few minutes, as iucnsim is running MCMC algorithms to estimate the status transition rates. Don't worry in case you get the message `Error in .Call(_reticulate_py_str_impl, x) : reached elapsed time limit`, this has no effect on the functionality of the function.


```{r}
transition_rates_out = estimate_transition_rates(all_target_species_status,
                                                iucn_history_file,
                                                outdir='iucnsim',
                                                possibly_extinct_list = c())
```

Now we are ready to run the future simulations. Set a number of years you want to simulate into the future and `iucnsim` will run empirical simulations based on the estimated status transition rates and based on extinction probabilities that are associated with each IUCN status. See the [`iucnsim` tutorial](https://github.com/tobiashofmann88/iucnsim) for more info how extinction probabilties are modeled.

```{r}
sim_years = 50
future_sim_output = run_future_sim(transition_rates_out,
                                   outdir='iucnsim',
                                   n_years=sim_years,
                                   n_sim=100)
# extract the different output items
extinction_times = future_sim_output[[1]]
future_div_min_max = future_sim_output[[2]]
status_through_time_trajectories = future_sim_output[[3]]
```

In the output folder you will find some summary plots, but you can also plot the output objects returned by the `run_future_sim()` directly in R (e.g. plot the diversity through time trajectory, including confidence intervals `future_div_min_max`).

You can also estimate species specific extinction rates using `iucnsim`, using the simulation output. For precise estimates of these rates it is recommendable to run the simulations produced in the previous step for at least 10,000 repititions (set `n_sim=10000`). This will take several minutes up to hours to finish, so here for demonstration purposes we stick to our 100 simulation repitions produced above. Let's now estimate the species-specific extinction rates. This will take several minutes as iucnsim runs a separate MCMC for each species in the dataset to estimate the extinction rates.

```{r}
ext_rates = estimate_extinction_rates(extinction_times,
                                      sim_years,
                                      outdir='iucnsim',
                                      load_from_file=FALSE)
```
