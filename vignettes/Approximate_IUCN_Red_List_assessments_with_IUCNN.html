<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Approximate Red List assessments with IUCNN</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/combine/gh/highlightjs/cdn-release@11.6.0/build/highlight.min.js,npm/@xiee/utils/js/load-highlight.js" async></script>



<style type="text/css">
body, td {
  font-family: sans-serif;
  background-color: white;
  font-size: 13px;
}
body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
}
tt, code, pre {
  font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}
a:visited { color: #80007f; }
pre, img { max-width: 100%; }
code {
  font-size: 92%;
  border: 1px solid #ccc;
}
code[class] { background-color: #F8F8F8; }
code.language-undefined { background-color: inherit; }
table {
  margin: auto;
  border-top: 1px solid #666;
  border-bottom: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color:#666;
  margin:0;
  padding-left: 1em;
  border-left: 0.5em #eee solid;
}
hr { border: 1px #ddd dashed; }

@media print {
  * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
  }
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  a, a:visited { text-decoration: underline; }
  hr {
    visibility: hidden;
    page-break-before: always;
  }
  pre, blockquote {
    padding-right: 1em;
    page-break-inside: avoid;
  }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page :left { margin: 15mm 20mm 15mm 10mm; }
  @page :right { margin: 15mm 10mm 15mm 20mm; }
  p, h2, h3 { orphans: 3; widows: 3; }
  h2, h3 { page-break-after: avoid; }
}
</style>



</head>

<body>
<h1>Background</h1>
<p>The Red List of the International Union for the Conservation of nature (<a href="http://www.iucn.org">www.iucn.org</a>, IUCN RL), is arguably one of the most thorough and widely used tools to assess the global extinction risk of species. However, the IUCN RL assessment process—usually performed by a group of specialists for each taxonomic group, or professional assessors—are time consuming, and therefore only a small fraction of global biodiversity has been evaluated for the IUCN RL, with a strong bias towards vertebrates and certain regions. These biases and the low fraction of species evaluated, bias conservation towards evaluated groups and prevent synthetic, large-scale ecological and biogeographic analyses of extinction risk.</p>
<p>IUCNN implements neural networks to predict the IUCN status of so far not evaluated or data deficient species based on species traits. IUCNN models are trained on the existing IUCN RL assessments and any traits may be used for prediction, although IUCNN implements a workflow based solely on publicly available geo-referenced species occurrence records and environmental data. Typical examples for the application of IUCNN are to predict the conservation status of a large number of species, to approximate extinction risk or number of threatened species in a region or specific taxonomic group for synthetic analyses or to predict the IUCN category of individual species of interest for systematic or ecological case studies.</p>
<pre><code class="language-r">library(IUCNN)
library(magrittr)
library(dplyr)
</code></pre>
<h1>Installation</h1>
<p>IUCNN uses R and python. All software needed can be installed via R.</p>
<ol>
<li>install IUCNN directly from Github using devtools.</li>
</ol>
<pre><code class="language-r">install.packages(&quot;devtools&quot;)
library(devtools)
library(IUCNN)
</code></pre>
<ol start="2">
<li>Python needs to be installed, for instance using miniconda and reticulated from within R (this will need c. 3 GB disk space).
If problems occur at this step, check the excellent <a href="https://rstudio.github.io/reticulate/index.html">documentation of reticulate</a>.</li>
</ol>
<pre><code class="language-r">install.packages(reticulate)
library(&quot;reticulate&quot;)
install_miniconda()
</code></pre>
<p>If python has been installed before, you can specify the python version to sue with <code>reticulate::use_python()</code></p>
<ol start="3">
<li>Install the tensorflow Python module. IUCNN uses functions of the python modules tensorflow and npBNN which also need to be installed (via R).</li>
</ol>
<pre><code class="language-r">reticulate::conda_install(&quot;r-reticulate&quot;,&quot;tensorflow=2.4&quot;)
reticulate::py_install(&quot;https://github.com/dsilvestro/npBNN/archive/v0.1.10.tar.gz&quot;, 
                       pip = TRUE)
</code></pre>
<h1>Prepare input data</h1>
<p>IUCNN predicts the IUCN RL categories of Not Evaluated and Data Deficient species based on geographic occurrence records and a set of training species for which occurrence records and IUCN assessments that are available for a set of reference species (training data). The amount of training species necessary varies with the number of categories but in general “the more, the better”. Ideally, the training dataset should comprise several hundred species or more, so a typical scenario will be to use all available plant species from a region, or all available species from a plant family. If the availability of training species is limited, a good option can be to reduce detail and predict Possibly threatened (IUCN categories “CR”, “EN”, and “VU”) v. Not threatened species (“NT” and “LC”).</p>
<p>Three types of input are necessary, which are easily available for many species:</p>
<h2>1. Geographic occurrence records of training species (training occurrences)</h2>
<p>Occurrence records might be obtained from a variety of databases, For example, from field collections or public databases such BIEN (<a href="https://bien.nceas.ucsb.edu/bien/">https://bien.nceas.ucsb.edu/bien/</a>) or GBIF (<a href="http://www.gbif.org">www.gbif.org</a>). GBIF data can be obtained from within R via the rgbif package, See <a href="https://docs.ropensci.org/rgbif/articles/index.html">here</a> for a tutorial on how to do so. IUCNN needs a dataset with (at least) three columns, containing the species name, decimal longitude coordinates and decimal latitude coordinates. If you are interested in cleaning records from GBIF, you may want to have a look at this <a href="https://data-blog.gbif.org/post/gbif-filtering-guide/">blog post</a> and check out the <a href="https://github.com/ropensci/CoordinateCleaner">CoordinateCleaner</a> and <a href="https://github.com/EduardoArle/bRacatus">bRacatus</a> packages.</p>
<h2>2. IUCN Global Red List assessment of the training species (training labels)</h2>
<p>IUCN RL assessments for the training species can be obtained from IUCN, either via <a href="http://www.iucnredlist.org">www.iucnredlist.org</a> or via the rredlist package via R (preferred for many species). See <a href="https://ropensci.org/tutorials/rredlist_tutorial/">here</a> for a tutorial on how to use rredlist. It is important, that all target label classes are well represented in the training data, which is rarely the case for IUCN data, since for instance “VU” and “NT” is rare. If the classes are to imbalanced, consider using possibly threatened (IUCN categories “CR”, “EN”, and “VU”) v. not threatened species (“NT” and “LC”), or the supersampling option of the <code>iucnn_train_model</code> function.</p>
<h2>3. Geographic occurrence records of the species for which the IUCN status should be predicted (predict occurrences)</h2>
<p>Geographic occurrence for the target species, in the same format as for the training occurrences described above.</p>
<p>Example dataset are available with IUCNN: <code>data(training_occ)</code> (training occurrences), <code>data(training_labels)</code> (training labels) and <code>data(prediction_occ)</code>.</p>
<h2>Feature preparation</h2>
<p>IUCNN uses per species traits to as features for the neural networks. The required input format is a data.frame with one row per species , one column containing the species name and any number of additional columns containing the numerical features for each species. In general, features might represent any trait, for instance from taxonomy (e.g., family), anatomy (e.g., body size), ecology (e.g., feeding guild) or conservation (e.g., population dynamics). However, since often only geographic occurrence data are available IUCNN contains functions to obtain default features from geo-referenced occurrence records alone, by combining them with publicly available environmental data. These default features informing on species range, climatic niche, human footprint and biomes. See Table 2 for a detailed list of all default features. Users may chose to use specific groups of features only via the <code>type</code> option of <code>iucnn_prepare_labels</code>. In this tutorial, we will use the example datasets from the Orchid family (Orchidaceae) provided with the IUCNN package,</p>
<p>You can prepare the default features with a single call to <code>iucnn_prepare_features</code></p>
<pre><code class="language-r">data(&quot;training_occ&quot;) #geographic occurrences of species with IUCN assessment
data(&quot;prediction_occ&quot;)

features_train &lt;- iucnn_prepare_features(training_occ) # Training features
features_predict &lt;- iucnn_prepare_features(prediction_occ) # Prediction features
</code></pre>
<h2>Label preparation</h2>
<p>IUCNN expects the labels for training as numerical categories. So, to use IUCN RL categories, those need to be converted to numeric in the right way. This can be done using the <code>iucnn_prepare_labels</code> function. The function converts the category labels as obtained from the IUCN RL into standardized numeric values, either on the detailed level of IUCN RL categories or the broader Possibly threatened/Not threatened level. See <code>?iucnn_prepare_labels</code> for more information. The labels will be converted into numeric categories following the <code>accepted_labels</code> argument, so for instance, in the default case: LC -&gt; 0 and CR -&gt; 4. If you change the accepted labels, the match will change accordingly.</p>
<pre><code class="language-r">data(&quot;training_labels&quot;)

labels_train &lt;- iucnn_prepare_labels(x = training_labels,
                                     y = features_train) # Training labels
</code></pre>
<h1>Running IUCNN</h1>
<p>Running IUCNN consists of two steps: 1) training a neural network and 2) predicting the status of new species. IUCNN contains three different neural network approaches to predict the IUCN status of species, which can all be customized. We present the default approach here, see section “Customizing analyses” of this tutorial for details on how to train a Bayesian or regression type neural network.</p>
<h2>Model training</h2>
<p>Based on the training features and labels, IUCNN trains a neural network, via the <code>iucnn_train_model</code> function. There are multiple options to customize the design of the network, including among others the number of layers and the fraction of records used for testing and validation. The <code>iucnn_train_model</code> function will write a folder to the working directory containing the model and return summary statistics including cross-entropy loss and accuracy for the validation set, which can be used to compare the performance of different models.</p>
<p>The following code trains a neural network model with 3 hidden layers of 60, 60, and 20 nodes, with ReLU activation function. By specifying a seed (here, the default: 1234) we make sure the same subsets of data are designated as training, validation and test sets across different runs and model configurations (see below). The model with estimated weights will be saved in the current working directory.</p>
<pre><code class="language-r">res_1 &lt;- iucnn_train_model(x = features_train,
                           lab = labels_train, 
                           path_to_output = &quot;iucnn_model_1&quot;)
#&gt; Training model on 712 training instances (177 test instances)...
#&gt; Best training epoch:  64
#&gt; 
 1/23 [&gt;.............................] - ETA: 2s
23/23 [==============================] - 0s 1ms/step
#&gt; 
1/6 [====&gt;.........................] - ETA: 0s
6/6 [==============================] - 0s 1ms/step
#&gt; IUC-NN model saved at:  iucnn_model_1/nn_model_0
</code></pre>
<p>The <code>summary</code> and <code>plot</code> methods give an overview on the training process and model performance.</p>
<pre><code class="language-r">summary(res_1)
#&gt; A model of type nn-class, trained on 712 species and 45 features.
#&gt; 
#&gt; Training accuracy: 0.629
#&gt; Validation accuracy: 0.58
#&gt; Accuracy on unseen data (test set): 0.633
#&gt; 
#&gt; Label detail: 5 Classes (detailed)
#&gt; 
#&gt; Label representation
#&gt;   Label Input_count Estimated_count
#&gt; 1     0          82             107
#&gt; 2     1           8               0
#&gt; 3     2          16               0
#&gt; 4     3          46              46
#&gt; 5     4          25              24
#&gt; 
#&gt; Confusion matrix (rows test data and columns predicted):
#&gt;    LC NT VU EN CR
#&gt; LC 71  0  0  7  4
#&gt; NT  7  0  0  1  0
#&gt; VU 10  0  0  4  2
#&gt; EN 15  0  0 27  4
#&gt; CR  4  0  0  7 14
plot(res_1)
</code></pre>
<p><img src="figure/unnamed-chunk-8-1.png" alt="plot of chunk unnamed-chunk-8" /></p>
<h2>Predict IUCN Global Red List status</h2>
<p>The trained model can then predict the conservation status of <em>Not Evaluated</em> and <em>Data Deficient</em> species with the <code>iucnn_predict_status</code> function. The output contains a data frame with species names and numeric labels (as generated with iucnn_prepare_labels).</p>
<pre><code class="language-r">predictions &lt;- iucnn_predict_status(x = features_predict, 
                                    model = res_1)

plot(predictions)
</code></pre>
<p><img src="figure/unnamed-chunk-9-1.png" alt="plot of chunk unnamed-chunk-9" /></p>
<p>It is important to remember the following when using IUCNN:</p>
<ol>
<li>
<p>The resulting IUCNN categories are approximations only. While IUCNN has reached accuracies between 80 and 90% on the broad (threatened v non-threatened) level and up to 80% on the detailed level in some cases, the accuracy may be considerably lower in other cases, which means that some species will be mis-classified.</p>
</li>
<li>
<p>IUCNN is indifferent to the provided features. On the one hand this means that any species traits for which data is available can be used, but on the other hand this means that thought is needed in the choice of the features. The default features of IUCNN are usually a safe choice. The number of features is not limited, but currently IUCNN does not support missing values in the feature table and removes species with missing values.</p>
</li>
<li>
<p>IUCNN is indifferent to the relation between training and test data. So it is possible to use training data from Palearctic birds to predict the conservation status of South American Nematodes. This is not recommended. Instead, a better approach will be to predict the conservation status of species, from training data of the same genus, order, or family. Alternatively, training data could be chosen on geographic region or functional aspects (e.g., feeding guild or body size). However some inclusion of taxonomy/evolutionary history for the choice of training data is recommended.</p>
</li>
<li>
<p>The amount of training data is important. The more the better. Minimum several hundred training species with a more or less equal distribution on the label classes should be included. If training data is limited, the broader Threatened/Not threatened level is recommended.</p>
</li>
<li>
<p>If the proportion of the IUCN RL categories is imbalanced in the training data, the neural networks may be biased towards reproducing these frequencies in the prediction, especially if the imbalance of categories or the difference in category frequencies among training and prediction set are large. To avoid this category frequencies should be balanced in the training data if possible. Otherwise the use of the <code>supersampling</code> or option a <code>nn-reg</code> type model, or a limitation to the broader Possibly threatened/Not threatened level of detail may remedy the issue.</p>
</li>
<li>
<p>IUCNN predictions are not equivalent to full IUCN Red List assessments. We see the main purpose of IUCNN in 1) identifying species that will likely need conservation action to trigger a full IUCN assessment, and 2) provide large-scale overviews on the extinction risk in a given taxonomic group, for instance in a macro-ecological and macro-evolutionary context.</p>
</li>
</ol>
<h1>Customizing IUCNN analyses</h1>
<p>IUCNN contains multiple options to customize the steps of the analyses to adapt the fully connected neural networks to the peculiarities of IUCN RL and species distribution data. Below we describe the most important options to customize 1) feature and label preparation, 2) model training and testing, and 3) status prediction. The most important steps and options to customize an IUCNN analysis are summarized in Table 1.</p>
<p>Table 1. Critical steps to customize an IUCNN analysis and relevant considerations at each point.</p>
<table>
<thead>
<tr>
<th>Step</th>
<th>Function(s)</th>
<th>Argument</th>
<th>Description</th>
<th>User consideration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Feature design</td>
<td>iucnn_prepare_features, iucnn_feature_importance</td>
<td>-</td>
<td>Defines the features to be extracted from the provided occurrence records. Available defaults are: biome presence, bioclim variables, human footprint and geographic features. Averaged per species and rescaled.</td>
<td>What determines extinction risk for target group? Which data are available? What do the results of feature importance suggest?</td>
</tr>
<tr>
<td>Label detail</td>
<td>prep_labels</td>
<td>level, threatened</td>
<td>Into how many different categories should the species be classified. Can be any number, defaults support full IUCN categories (LC, NT, VU, EN, CR) or binary (Possibly threatened v. Not threatened)</td>
<td>Which detail is needed? Is the accuracy of the detailed level sufficient for the target application?</td>
</tr>
<tr>
<td>Model type</td>
<td>iucnn_train_model</td>
<td>mode</td>
<td>Which model framework should be applied: a categorical classification, a classification taking the ordinal number of categories into account, or a classification based in a Bayesian framework</td>
<td>How many target categories are there? How important is a high accuracy for intermediate classes (e.g. VU, NT, EN)? How important is the uncertainty estimation for each species?</td>
</tr>
<tr>
<td>Model structure</td>
<td>iucnn_train_model</td>
<td>validation fraction</td>
<td>The fraction of the input training data used for validation (v. training).</td>
<td>Which fraction of the data should be used for validation (and hence not training)? How large is the training data?</td>
</tr>
<tr>
<td>Model structure</td>
<td>iucnn_train_model</td>
<td>cv_fold</td>
<td>The number of folds used for cross-validation. For instance if = 5, the data is divided into 5 folds with 20% of the data used for validation in each run.</td>
<td>How large is the training data?</td>
</tr>
<tr>
<td>Model structure</td>
<td>iucnn_train_model</td>
<td>n_layers</td>
<td>The number of hidden layers and nodes in the neural network.</td>
<td>How complex should the model be?</td>
</tr>
<tr>
<td>Model structure</td>
<td>iucnn_train_model</td>
<td>balance_classes</td>
<td>Should the frequency of the class labels in the training data be balanced using supersampling?</td>
<td>How imbalanced are the class labels? Will the frequency of class labels differ between training data and prediction data set?</td>
</tr>
<tr>
<td>Model structure</td>
<td>iucnn_train_model</td>
<td>act_f_out/act_f</td>
<td>The activation function of the neural network</td>
<td>Which relationship between features and labels is expected?</td>
</tr>
<tr>
<td>Model structure</td>
<td>iucnn_train_model</td>
<td>label_stretch_factor</td>
<td>The factor to stretch input class labels to</td>
<td>Am I using a nn-reg type model?  Does model testing suggest an effect on model accuracy?</td>
</tr>
<tr>
<td>Model structure</td>
<td>iucnn_train_model</td>
<td>drop_out rate</td>
<td>The number of nodes to be removed in individual epochs. Necessary if a target threshold is to be used with a nn-class model (not bnn-class though)</td>
<td>Is a target accuracy to be sued for prediction? How many nodes are there in the model?</td>
</tr>
<tr>
<td>Prediction</td>
<td>predict_iucnn</td>
<td>target_acc</td>
<td>Defines an overall target accuracy for the model Species which cannot be classified with enough certainty to reach this threshold are labels as data deficient.</td>
<td>Which error rate is acceptable? Which proportion of species needs to be included?</td>
</tr>
</tbody>
</table>
<h2>1) Features and Labels</h2>
<h3>Add and remove feature blocks</h3>
<p>The default features are selected based on empirical tests on relevance for different taxa and regions. However, for some analyses only part of the features may be relevant. You can exclude feature blocks using the <code>type</code> argument of the <code>iucnn_prepare_features</code> function. For instance, to exclude the biome features:</p>
<pre><code class="language-r">features_train2 &lt;- iucnn_prepare_features(training_occ, 
                                          type = c(&quot;geographic&quot;, 
                                                   &quot;climate&quot;, 
                                                   &quot;humanfootprint&quot;))
</code></pre>
<h3>Prepare features individually</h3>
<p>If more control over feature preparation is necessary, each feature block can be obtained by an individual function.</p>
<p>Table 2. Functions to obtain default features and options to customize the features.</p>
<table>
<thead>
<tr>
<th>Feature block</th>
<th>Function name</th>
<th>Options to customize</th>
</tr>
</thead>
<tbody>
<tr>
<td>Geographic</td>
<td><code>iucnn_geographic_features</code></td>
<td>-</td>
</tr>
<tr>
<td>Biomes</td>
<td><code>iucnn_biome_features</code></td>
<td>change the reference dataset of biomes (biome_input, biome.id), remove biomes without any species occurrence (remove_zeros)</td>
</tr>
<tr>
<td>Climate</td>
<td><code>iucnn_climate_features</code></td>
<td>the amount of bioclim variables from the default source to be included (type), the resolution of the default input data (res)</td>
</tr>
<tr>
<td>Human footprint</td>
<td><code>iucnn_footprint_features</code></td>
<td>chose the time points from the default source (year), the break points for the different footprint categories (breaks, by default approximately quantiles on the global footprint dataset) or a default source for human footprint (footp_input)</td>
</tr>
<tr>
<td>Geographic bias</td>
<td><code>iucnn_bias_features</code></td>
<td>The resolution of the bias raster (res) or providing a template raster (ras)</td>
</tr>
</tbody>
</table>
<p>For instance:</p>
<pre><code class="language-r">clim_features &lt;- iucnn_climate_features(x = training_occ, 
                                        type = &quot;selected&quot;)

clim_features2 &lt;- iucnn_climate_features(x = training_occ, 
                                         type = &quot;all&quot;)
</code></pre>
<h3>Use custom features</h3>
<p>It is also possible to provide features unrelated to the default features. They may contain any continuous or categorical features, but some processing will be needed. The format needs to be a data.frame with a compulsory column containing the species name. Continuous variables should be rescaled to cover a similar range, whereas categorical features should be coded binary (present/absent, as the results of <code>iucnn_biome_features</code>).</p>
<p>For instance:</p>
<pre><code class="language-r">feat &lt;- data.frame(species = c(&quot;Adansonia digitata&quot;, &quot;Ceiba pentandra&quot;),
 max_plant_size_m = c(25, 50),
 africa = c(1,1),
 south_america = c(0,1),
 fraction_of_records_in_protected_area = c(25, 75))
</code></pre>
<p>Table 3. Description of the default features included in <code>iucnn_prepare_features</code>. All continuous variables are rescaled to a similar range.</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Block</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>tot_occ</td>
<td>Geographic</td>
<td>Number of occurrences</td>
<td>The total number of occurrences available for this species</td>
</tr>
<tr>
<td>uni_occ</td>
<td>Geographic</td>
<td>Number of geographically unique occurrences</td>
<td>The number of geographically unique records available for this species</td>
</tr>
<tr>
<td>mean_lat</td>
<td>Geographic</td>
<td>Mean latitude</td>
<td>The mean latitude of all records of this species</td>
</tr>
<tr>
<td>mean_lon</td>
<td>Geographic</td>
<td>Mean longitude</td>
<td>The mean longitude of all records of this species</td>
</tr>
<tr>
<td>lat_range</td>
<td>Geographic</td>
<td>Latitudinal range</td>
<td>The latitudinal range (.95 quantile - .05 quantile).</td>
</tr>
<tr>
<td>lon_range</td>
<td>Geographic</td>
<td>Longitudinal range</td>
<td>The longitudinal range (.95 quantile - .05 quantile).</td>
</tr>
<tr>
<td>alt_hemisphere</td>
<td>Geographic</td>
<td>The hemisphere</td>
<td>0 = Southern hemisphere, 1 = Northern hemisphere</td>
</tr>
<tr>
<td>eoo</td>
<td>Geographic</td>
<td>Extend of Occurrence</td>
<td>The extend of occurrence. Calculated by rCAT. For species with less than 3 records set to AOO</td>
</tr>
<tr>
<td>aoo</td>
<td>Geographic</td>
<td>Area of Occupancy</td>
<td>The area of occupancy, as the sum of area of 4sqkm grid cells, where the species occurs</td>
</tr>
<tr>
<td>1</td>
<td>Biome</td>
<td>Tropical &amp; Subtropical Moist Broadleaf Forests</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>2</td>
<td>Biome</td>
<td>Tropical &amp; Subtropical Dry Broadleaf Forests</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>3</td>
<td>Biome</td>
<td>Tropical &amp; Subtropical Coniferous Forests</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>4</td>
<td>Biome</td>
<td>Temperate Broadleaf &amp; Mixed Forests</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>5</td>
<td>Biome</td>
<td>Temperate Conifer Forests</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>6</td>
<td>Biome</td>
<td>Boreal Forests/Taiga</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>7</td>
<td>Biome</td>
<td>Tropical &amp; Subtropical Grasslands, Savannas &amp; Shrublands</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>8</td>
<td>Biome</td>
<td>Temperate Grasslands, Savannas &amp; Shrublands</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>9</td>
<td>Biome</td>
<td>Flooded Grasslands &amp; Savannas</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>10</td>
<td>Biome</td>
<td>Montane Grasslands &amp; Shrublands</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>11</td>
<td>Biome</td>
<td>Tundra</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>12</td>
<td>Biome</td>
<td>Mediterranean Forests, Woodlands &amp; Scrub</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>13</td>
<td>Biome</td>
<td>Deserts &amp; Xeric Shrublands</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>14</td>
<td>Biome</td>
<td>Mangroves</td>
<td>Tropical &amp; Subtropical Moist Broadleaf Forests</td>
</tr>
<tr>
<td>98</td>
<td>Biome</td>
<td>Lake</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>99</td>
<td>Biome</td>
<td>Rock and ice</td>
<td>Are at least 5% of the species records present in this biome?</td>
</tr>
<tr>
<td>bio1</td>
<td>Climate</td>
<td>Annual Mean Temperature</td>
<td>The median value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed</td>
</tr>
<tr>
<td>bio4</td>
<td>Climate</td>
<td>Temperature Seasonality</td>
<td>The median value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed</td>
</tr>
<tr>
<td>bio11</td>
<td>Climate</td>
<td>Mean Temperature of Coldest Quarter</td>
<td>The median value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed</td>
</tr>
<tr>
<td>bio12</td>
<td>Climate</td>
<td>Annual Precipitation</td>
<td>The median value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed</td>
</tr>
<tr>
<td>bio15</td>
<td>Climate</td>
<td>Precipitation Seasonality</td>
<td>The median value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed</td>
</tr>
<tr>
<td>bio17</td>
<td>Climate</td>
<td>Precipitation of Driest Quarter</td>
<td>The median value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed</td>
</tr>
<tr>
<td>range_bio1</td>
<td>Climate</td>
<td>Range of annual Mean Temperature</td>
<td>The range of value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed. Range is the .95-.05 quantile.</td>
</tr>
<tr>
<td>range_bio4</td>
<td>Climate</td>
<td>Range of temperature Seasonality</td>
<td>The range of value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed. Range is the .95-.05 quantile.</td>
</tr>
<tr>
<td>range_bio11</td>
<td>Climate</td>
<td>Range of mean Temperature of Coldest Quarter</td>
<td>The range of value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed. Range is the .95-.05 quantile.</td>
</tr>
<tr>
<td>range_bio12</td>
<td>Climate</td>
<td>Range of annual Precipitation</td>
<td>The range of value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed. Range is the .95-.05 quantile.</td>
</tr>
<tr>
<td>range_bio15</td>
<td>Climate</td>
<td>Range of precipitation Seasonality</td>
<td>The range of value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed. Range is the .95-.05 quantile.</td>
</tr>
<tr>
<td>range_bio17</td>
<td>Climate</td>
<td>Range of precipitation of Driest Quarter</td>
<td>The range of value of this bioclimatic layer for the occurrence records of a species. Records with NA values removed. Range is the .95-.05 quantile.</td>
</tr>
<tr>
<td>humanfootprint_1993_1</td>
<td>Human footprint</td>
<td>Human footprint year 1993 lowest impact</td>
<td>The fraction of records in areas of the lowest category of human footprint in the year 1993. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
<tr>
<td>humanfootprint_1993_2</td>
<td>Human footprint</td>
<td>Human footprint year 1993 intermediate impact 1</td>
<td>The fraction of records in areas of the second lowest category of human footprint in the year 1993. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
<tr>
<td>humanfootprint_1993_3</td>
<td>Human footprint</td>
<td>Human footprint year 1993 intermediate impact 2</td>
<td>The fraction of records in areas of the second highest category of human footprint in the year 1993. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
<tr>
<td>humanfootprint_1993_4</td>
<td>Human footprint</td>
<td>Human footprint year 1993 highest impact</td>
<td>The fraction of records in areas of the highest category of human footprint in the year 1993. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
<tr>
<td>humanfootprint_2009_1</td>
<td>Human footprint</td>
<td>Human footprint year 2009 lowest impact</td>
<td>The fraction of records in areas of the lowest category of human footprint in the year 2009. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
<tr>
<td>humanfootprint_2009_2</td>
<td>Human footprint</td>
<td>Human footprint year 2009 intermediate impact 1</td>
<td>The fraction of records in areas of the second lowest category of human footprint in the year 2009. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
<tr>
<td>humanfootprint_2009_3</td>
<td>Human footprint</td>
<td>Human footprint year 2009 intermediate impact 2</td>
<td>The fraction of records in areas of the second highest category of human footprint in the year 2009. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
<tr>
<td>humanfootprint_2009_4</td>
<td>Human footprint</td>
<td>Human footprint year 2009 highest impact</td>
<td>The fraction of records in areas of the highest category of human footprint in the year 2009. Footprint was categorized so that categorize represent roughly quantiles.</td>
</tr>
</tbody>
</table>
<h3>Labels: Full categories vs Threatened/Not threatened</h3>
<p>The <code>iucnn_prepare_labels</code> function may accepted any custom labels as long as they are included in the <code>accepted_labels</code> option. It also can provide a classification into threatened/non-threatened, via the <code>level</code> and <code>threatened</code> options. On the broader level the model accuracy is usually significantly higher.</p>
<p>For instance:</p>
<pre><code class="language-r">labels_train &lt;- iucnn_prepare_labels(training_labels,
                                     y = features, 
                                     level = &quot;broad&quot;)
</code></pre>
<h2>2) Model training - NN regression model</h2>
<h3>Customizing model parameters</h3>
<p>The <code>iucnn_train_model</code> function contains various options to customize the neural network, including among other the fraction of validation and test data, the maximum number of epochs, the number of layers and nodes, the activation function , dropout and randomization of the input data. See <code>?iucnn_train_model</code> for a comprehensive list of options and their description. By default, <code>iucnn_train_model</code> trains a neural network with three hidden layers with 50, 30 and 10 nodes and a sigmoid as activation function. Depending on your dataset different networks may improve performance. For instance, you can set up a different model with 1 hidden layer of 60 nodes, a sigmoid activation function and without using a bias node in the first hidden layer.</p>
<pre><code class="language-r">res_2 &lt;- iucnn_train_model(x = features_train,
 lab = labels_train, 
 dropout_rate = 0.3,
 path_to_output= &quot;iucnn_model_2&quot;,
 n_layers = &quot;60&quot;,
 use_bias = FALSE,
 act_f = &quot;sigmoid&quot;)
</code></pre>
<p>You can compare the validation loss of the models using <code>res_1$validation_loss</code> and <code>res_2$validation_loss</code>. Model 2 in this case yields a lower validation loss and is therefore preferred. Once you chose the preferred model configuration based on validation loss, we can check test accuracy of best model: <code>res_2$test_accuracy</code>. The <code>iucnn_train_model</code> function contains various options to adapt the model. See <code>?iucnn_train_model</code> for more detail.</p>
<h3>Changing the modeling algorithm</h3>
<p>There are three neural network algorithms implemented in IUCNN. Besides the default classifier approach based on a tensorflow implementation, these are a Bayesian neural network classifier and a regression type neural network.</p>
<p>The Bayesian approach has the advantage that it returns true probabilities for the classification of species into the relative output classes (e.g. 80% probability of a species to be LC). We consider this approach more suitable for classification of species into IUCN categories, than the default option. It will need more time for model training and should best be applied once you have identified the best model parameters using the default approach. You can run a BNN setting the <code>mode</code> option of <code>iucnn_train_model</code> to <code>&quot;bnn-class&quot;</code>.</p>
<pre><code class="language-r">res_3 &lt;- iucnn_train_model(x = features_train,
 lab = labels_train, 
 path_to_output = &quot;iucnn_model_3&quot;,
 mode = 'bnn-class')
</code></pre>
<p>IUCNN also offers the option to train a NN regression model instead of a classifier. Since the IUCN threat statuses constitute a list of ordinal categories sorted by increasing threat level, we can model the task of estimating these categories as a regression problem. Such a model can be trained with the <code>iucnn_train_model()</code> function, specifying to train a regression model by setting <code>mode = 'nn-reg'</code>.</p>
<pre><code class="language-r">res_4 &lt;- iucnn_train_model(x = features_train,
 lab = labels_train, 
 path_to_output = &quot;iucnn_model_4&quot;,
 mode = 'nn-reg',
 rescale_features = TRUE)
</code></pre>
<h3>Feature importance</h3>
<p>The <code>iucnn_feature_importance</code> function can be used to gauge the importance of different feature blocks or individual features for model performance. The function implements the permutation feature importance technique, which randomly reshuffles the values within individual features or blocks of features and evaluate how this randomization affects the models prediction accuracy. If a given feature (or block of features) is important for the models ability to predict, randomizing this feature will lead to a large drop in prediction accuracy. When using <code>iucnn_feature_importance</code> with features other than the default, feature blocks can be defined using the <code>feature_blocks</code> option.</p>
<pre><code class="language-r">fi &lt;- iucnn_feature_importance(x = res_1)
plot(fi)
</code></pre>
<p><img src="figure/unnamed-chunk-17-1.png" alt="plot of chunk unnamed-chunk-17" /></p>
<h3>Model testing</h3>
<p>Before training the final model used for predicting the conservation status of not evaluated species, it is recommended to use the <code>iucnn_modeltest</code> function for finding the best settings for your model and dataset. This process, often referred to as hyperparameter tuning, is an essential step for building the most suitable model for the prediction task. The <code>iucnn_modeltest</code> function allows you to provide any settings for <code>iucnn_train_model</code> as vectors, which will lead the function to train a separate model for each provided setting. The function will explore all possible permutations of the provided settings, so that the following command results in 9 different models being trained:</p>
<pre><code class="language-r">modeltest_results &lt;- iucnn_modeltest(features,
 labels,
 dropout_rate = c(0.0,0.1,0.3),
 n_layers = c('30','40_20','50_30_10'))
</code></pre>
<p>The model specifications and settings of each tested model are written to a log-file and can be inspected with the <code>iucnn_best_model</code> function, to decide which model settings to pick as best model. Different criteria for picking the best model can be selected, such as best prediction accuracy, best predicted over-all status distribution, lowest weighted mis-classification error, etc.</p>
<pre><code class="language-r">best_m &lt;- iucnn_best_model(modeltest_results, criterion='val_acc')
</code></pre>
<p>After model testing, it is necessary to retrain using the model specifications identified by <code>iucnn_best_model</code>. It is possible to take the respective settings directly from the output of the <code>iucnn_best_model</code> function, via the <code>production-model</code> argument of <code>iucnn_train_model</code>.</p>
<pre><code class="language-r"># Train the best model on all training data for prediction
m_prod &lt;- iucnn_train_model(train_feat,
                      train_lab,
                      production_model = m_best,
                      overwrite = TRUE)
</code></pre>
<p>The production model can then be used for the final predictions.</p>
<pre><code class="language-r"># Predict RL categories for target species
pred &lt;- iucnn_predict_status(pred_feat,
                      m_prod)
plot(pred)
</code></pre>
<h2>3) Status prediction</h2>
<p>The <code>iucnn_predict_status</code> function offers options to customize the predictions. The most important option in many cases is <code>target_acc</code>, which allows to set an overall target-accuracy threshold that the model needs to achieve. This option is only available for nn-class and nn-reg models that were trained using dropout (see help function of <code>iucnn_train_model</code> for more explanation), as well as for all bnn-class models. The <code>target_acc</code> will be achieved by the model being more selective with making a category call for a given instance. All species that cannot be classified with enough certainty to reach this target accuracy will be classified as NA (Not Assessed).</p>
<pre><code class="language-r">pred_2 &lt;- iucnn_predict_status(x = features_predict, 
 target_acc = 0.7,
 model = res_2)
plot(pred_2)
</code></pre>
<p><img src="figure/unnamed-chunk-22-1.png" alt="plot of chunk unnamed-chunk-22" /></p>
<p>Furthermore, you can turn off the <code>return_IUCN</code> option if to return the numerical labels instead of the IUCNN RL category labels.</p>
<pre><code class="language-r">pred_3 &lt;- iucnn_predict_status(x = features_predict, 
 model = res_2,
 return_IUCN = FALSE)
</code></pre>
<p>The output of the <code>iucnn_predict_status</code> function is an “iucnn_predictions” object, that contains several output objects. The predicted labels of the individual instances are accessible with <code>pred_2$class_predictions</code> and label probabilities estimated by the neural network via <code>pred_2$mc_dropout_probs</code> for “nn-class” and “nn-reg” with dropout, or <code>pred_2$posterior_probs</code> for “bnn-class”. For more detail, the <code>pred_2$raw_predictions</code> object contains the individual label probabilities resulting from the softmax output layer in case of “nn-class”, or the regressed labels in case of “nn-reg”.</p>
<h2>4) The number of species per category</h2>
<p>Another statistic that can be extracted from the “iucnn_predictions” object is the overall category distribution predicted for the given prediction instances. This can be accessed with <code>pred_2$pred_cat_count</code>, which shows the distribution of the label predictions, including the count of species that could not be predicted given the chosen <code>target_acc</code>.</p>
<p>Another statistic are the <code>pred2$sampled_cat_freqs</code> (only available for dropout models and all “bnn-class” models, see above), which show the class distribution as sampled from the <code>pred_2$mc_dropout_probs</code> or the <code>pred_2$posterior_probs</code> (for “bnn-class” models). The difference between <code>pred2$sampled_cat_freqs</code> and <code>pred_2$mc_dropout_probs</code>/<code>pred_2$posterior_probs</code> is that the former represents the counts of the best labels determined for each instance, whereas the latter represents labels sampled from the predicted label probabilities, which also proportionally samples the labels for a given instance that do receive the maximum label probability. The latter is done repeatedly to include the stochasticity of the random sampling of classes from the given probability vectors. The <code>pred_2$mc_dropout_probs</code>/<code>pred_2$posterior_probs</code> can be used to plot histograms of the estimates for each class, and can be reported as uncertainty intervals around the number of species in each class for the set of species that were predicted.</p>
<h1>Training and prediction using a convolutional neural network</h1>
<p>Instead of the fully connected neural networks presented above, IUCNN also implements a prediction algorithm using Convolutional Neural Networks (CNNs). The input data for prediction are then rasterized per-species grids of occurrence numbers. Since the input features and network structure is different CNNs are implemented in IUCNN with a separate workflow.</p>
<h2>1. Feature preparation</h2>
<p>Features are prepared using the <code>iucnn_cnn_features</code> function which will count the number of occurrence records in a custom raster with the same extent as the species occurrences. The function can be simply run on a data frame of training and prediction occurrences separately. Yet, since the extent of these two datasets is likely different, it is recommendable to create a custom raster beforehand. Here, we will use a simple lat/lon raster, but users may provide coordinates and a raster in any suitable coordinate reference system, as long as they agree between occurrence coordinates and raster.</p>
<pre><code class="language-r"># preapre custom raster, you can split this step if training and test occurrences have the same extent
library(terra)
data(&quot;training_occ&quot;)
data(&quot;prediction_occ&quot;)

# find the minimum latitude and longitude values for the extent of the raster
min_lon &lt;- min(c(min(training_occ$decimallongitude), 
                 min(prediction_occ$decimallongitude)))
max_lon &lt;- max(c(max(training_occ$decimallongitude), 
                 max(prediction_occ$decimallongitude)))
min_lat &lt;- min(c(min(training_occ$decimallatitude), 
                 min(prediction_occ$decimallatitude)))
max_lat &lt;- max(c(max(training_occ$decimallatitude), 
                 max(prediction_occ$decimallatitude)))
## set the coordinate reference system
ras &lt;- rast(crs = &quot;+proj=longlat +datum=WGS84&quot;)
## set raster extent
ext(ras) &lt;- c(min_lon,
              max_lon, 
              min_lat, 
              max_lat)
## set raster resolution
res(ras) &lt;- 1 # the resolution in CRS units, in this case degrees lat/lon


 # Training features
cnn_features &lt;- iucnn_cnn_features(x = training_occ, 
                                   y = ras)

# Prediction features
cnn_features_predict &lt;- iucnn_cnn_features(x = prediction_occ,
                                           y = ras)
 # Training labels
cnn_labels &lt;- iucnn_prepare_labels(x = training_labels,
                                   y = cnn_features)
</code></pre>
<h2>2. Model training</h2>
<pre><code class="language-r">trained_model &lt;- iucnn_cnn_train(cnn_features,
                                cnn_labels,
                                overwrite = TRUE,
                                dropout_rate = 0.1,
                                optimize_for = 'accuracy')

plot(trained_model)
summary(trained_model)
</code></pre>
<h2>3. Status prediction</h2>
<pre><code class="language-r">pred &lt;- iucnn_predict_status(cnn_features_predict,
                             trained_model,
                             target_acc = 0.0
                             )
</code></pre>


<script src="https://cdn.jsdelivr.net/combine/npm/@xiee/utils/js/center-img.min.js" async></script>
</body>

</html>
